<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تقرير العمليات - الميناء (نمذج التوسعات)</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- شريط علوي بسيط مع أزرار -->
  <header class="topbar">
    <div class="topbar-inner">
      <nav class="top-nav">
        <button class="pill btn-light">العودة إلى الموقع</button>
        <button class="pill btn-ghost">تقرير العمليات الميناء</button>
      </nav>
    </div>
  </header>

  <div class="center-wrap">
    <section class="card">
      <h1 class="title">تقرير العمليات في الميناء</h1>
      <p class="hint">املأ الحقول ثم اضغط "انشاء التقرير"</p>

      <!-- محتوى البطاقة موزع إلى عمودين: يسار الحقول، يمين شريط العناوين/الأقسام -->
      <div class="card-grid">
        <!-- العمود الأيمن (في RTL سيظهر إلى اليمين) - مساحات/عناوين الأقسام -->
        <!-- العمود الأيسر: النموذج -->
        <main class="card-main">
          <form id="reportForm" onsubmit="return false;">
            <div class="row"><label>وقت استلام الشفت</label><input id="shiftTimeDisplay" class="input" value="6 صباحا" readonly></div>

            <div class="section">
              <h4 class="section-title">العمليات الأساسية</h4>
              <div id="radaList" class="group">
                <div class="row"><label>ردع 1</label><input class="input role" value="H-000" data-role="ردع 1"></div>
                <div class="row"><label>ردع 2</label><input class="input role" value="H-000" data-role="ردع 2"></div>
              </div>

              <div id="barqList" class="group">
                <div class="row"><label>برق 1</label><input class="input role" value="H-000" data-role="برق 1"></div>
                <div class="row"><label>برق 2</label><input class="input role" value="H-000" data-role="برق 2"></div>
              </div>

              <div id="saqrList" class="group">
                <div class="row"><label>صقر 1</label><input class="input role" value="H-000" data-role="صقر 1"></div>
                <div class="row"><label>صقر 2</label><input class="input role" value="H-000" data-role="صقر 2"></div>
                <div class="row"><label>صقر 3</label><input class="input role" value="H-000" data-role="صقر 3"></div>
                <div class="row"><label>صقر 4</label><input class="input role" value="H-000" data-role="صقر 4"></div>
              </div>

              <div id="sahmList" class="group">
                <div class="row"><label>سهم 1</label><input class="input role" value="H-000" data-role="سهم 1"></div>
                <div class="row"><label>سهم 2</label><input class="input role" value="H-000" data-role="سهم 2"></div>
                <div class="row"><label>سهم 3</label><input class="input role" value="H-000" data-role="سهم 3"></div>
              </div>
            </div>

            <div class="section" id="expansions">
              <h4 class="section-title">التوسعات</h4>

              <div class="expansion">
                <strong class="expansion-title">توسعه ( 1 )</strong>
                <div id="exp1SecurityList">
                  <div class="row"><label>أمن 1</label><input class="input role" value="H-000" data-role="أمن 1"></div>
                  <div class="row"><label>أمن 2</label><input class="input role" value="H-000" data-role="أمن 2"></div>
                </div>
                <div id="exp1HuraList">
                  <div class="row"><label>حرة 1</label><input class="input role" value="H-000" data-role="حرة 1"></div>
                  <div class="row"><label>حرة 2</label><input class="input role" value="H-000" data-role="حرة 2"></div>
                </div>
              </div>

              <div class="expansion">
                <strong class="expansion-title">توسعه ( 2 )</strong>
                <div id="exp2SecurityList">
                  <div class="row"><label>أمن 1</label><input class="input role" value="H-000" data-role="أمن 1"></div>
                  <div class="row"><label>أمن 2</label><input class="input role" value="H-000" data-role="أمن 2"></div>
                </div>
                <div id="exp2HuraList">
                  <div class="row"><label>حرة 1</label><input class="input role" value="H-000" data-role="حرة 1"></div>
                  <div class="row"><label>حرة 2</label><input class="input role" value="H-000" data-role="حرة 2"></div>
                </div>
              </div>

              <div class="expansion">
                <strong class="expansion-title">توسعه ( 3 )</strong>
                <div id="exp3SecurityList">
                  <div class="row"><label>أمن 1</label><input class="input role" value="H-000" data-role="أمن 1"></div>
                  <div class="row"><label>أمن 2</label><input class="input role" value="H-000" data-role="أمن 2"></div>
                </div>
                <div id="exp3HuraList">
                  <div class="row"><label>حرة 1</label><input class="input role" value="H-000" data-role="حرة 1"></div>
                  <div class="row"><label>حرة 2</label><input class="input role" value="H-000" data-role="حرة 2"></div>
                </div>
              </div>

              <div class="expansion">
                <strong class="expansion-title">توسعه ( 4 )</strong>
                <div id="exp4SecurityList">
                  <div class="row"><label>أمن 1</label><input class="input role" value="H-000" data-role="أمن 1"></div>
                  <div class="row"><label>أمن 2</label><input class="input role" value="H-000" data-role="أمن 2"></div>
                </div>
                <div id="exp4HuraList">
                  <div class="row"><label>حرة 1</label><input class="input role" value="H-000" data-role="حرة 1"></div>
                  <div class="row"><label>حرة 2</label><input class="input role" value="H-000" data-role="حرة 2"></div>
                </div>
              </div>
            </div>

            <div class="section" id="notesSection">
              <div class="row"><label>ملاحظة رئيسية</label><input id="noteField" class="input" value=""></div>

              <div class="row note-add" style="align-items:flex-start">
                <label>إضافة بند</label>
                <div style="flex:1;display:flex;gap:8px;align-items:center">
                  <input id="noteCode" class="input small" placeholder="مثال: H-018">
                  <input id="noteCount" class="input small" placeholder="ت 1">
                  <select id="noteType" class="input small">
                    <option value="">نوع</option><option value="حرة">حرة</option><option value="سهم">سهم</option><option value="صقر">صقر</option>
                  </select>
                  <button type="button" id="addNoteBtn" class="add-btn">＋ إضافة</button>
                </div>
              </div>

              <div class="row" style="align-items:flex-start">
                <label>ملاحظات مضافة</label>
                <div id="notesList" style="flex:1;display:flex;flex-direction:column;gap:6px"></div>
              </div>
            </div>

            <div class="form-actions">
              <button id="buildReport" type="button" class="btn primary">انشاء التقرير</button>
              <button id="copyReport" type="button" class="btn secondary" style="display:none">نسخ التقرير</button>
            </div>

            <div style="margin-top:12px">
              <textarea id="reportOutput" class="report-output" placeholder="سيظهر التقرير هنا بعد الضغط"></textarea>
            </div>
          </form>
        </main>
      </div>
    </section>
  </div>

<script>
  // JavaScript كما في النسخة الأصلية — بدون تغييرات منطقية، فقط لتفعيل البناء والنسخ.
  function extractSuffixNumber(labelText){
    if (!labelText) return '';
    const m = labelText.trim().match(/(\d+)\s*$/);
    return m ? m[1] : '';
  }
  function formatLine(roleName, value){
    const n = extractSuffixNumber(roleName);
    return roleName + ' : ' + value + (n ? ' | ت ' + n : '');
  }
  function readRowValue(row){
    if (!row) return null;
    const roleName = (row.querySelector('label')||{}).textContent || '';
    const codeInput = row.querySelector('.role');
    const playerChk = row.querySelector('.playerChk');
    const mention = row.querySelector('.playerMention');
    let val = 'H-000';
    if (playerChk && playerChk.checked){
      const raw = (mention && mention.value) ? mention.value.trim() : '';
      val = raw ? (raw.startsWith('@')?raw:('@'+raw)) : '@';
    } else if (codeInput){
      val = (codeInput.value && codeInput.value.trim()) ? codeInput.value.trim() : 'H-000';
    }
    return { roleName, val };
  }
  function buildReportText(){
    const out = [];
    const shiftLabel = 'الميناء';
    const timeLabel = (document.getElementById('shiftTimeDisplay') && document.getElementById('shiftTimeDisplay').value) || '6 صباحا';
    out.push('***تقرير العمليات في التوسعات ***');
    out.push('');
    out.push('**تم استلام عمليات ' + shiftLabel + ' في تمام الساعه ' + timeLabel + ' **');
    out.push('');
    ['radaList','barqList','saqrList','sahmList'].forEach(id=>{
      const container = document.getElementById(id);
      if (!container) return;
      const rows = container.querySelectorAll('.row');
      rows.forEach(r=>{
        if (r.dataset.hidden==='true' || getComputedStyle(r).display==='none') return;
        const data = readRowValue(r);
        if (data && data.roleName) out.push(formatLine(data.roleName, data.val));
      });
      out.push('');
    });
    function appendExpansion(n){
      out.push('**توسعه ( ' + n + ' ) **');
      const sec = document.getElementById('exp'+n+'SecurityList');
      if (sec){
        const rows = sec.querySelectorAll('.row');
        rows.forEach(r=>{
          if (r.dataset.hidden==='true' || getComputedStyle(r).display==='none') return;
          const d = readRowValue(r);
          if (d && d.roleName) out.push(formatLine(d.roleName, d.val));
        });
      }
      out.push('');
      const hura = document.getElementById('exp'+n+'HuraList');
      if (hura){
        const rows = hura.querySelectorAll('.row');
        rows.forEach(r=>{
          if (r.dataset.hidden==='true' || getComputedStyle(r).display==='none') return;
          const d = readRowValue(r);
          if (d && d.roleName) out.push(formatLine(d.roleName, d.val));
        });
      }
      out.push('');
    }
    appendExpansion(1); appendExpansion(2); appendExpansion(3); appendExpansion(4);
    const noteItems = Array.from(document.querySelectorAll('#notesList .note-item'));
    out.push('`ملاحظات التقرير :`');
    out.push('');
    if (document.getElementById('noteField').value.trim()){
      out.push(document.getElementById('noteField').value.trim());
    }
    if (noteItems.length){
      noteItems.forEach(it=>{
        const playerChk = it.querySelector('.playerChk');
        const mention = it.querySelector('.playerMention');
        const code = it.dataset.code||'';
        const count = it.dataset.count||'';
        const type = it.dataset.type||'';
        let line = '';
        if (playerChk && playerChk.checked){
          const raw = (mention && mention.value)?mention.value.trim():'';
          const m = raw ? (raw.startsWith('@')?raw:('@'+raw)) : '@';
          line = m + (type ? (' ' + type) : '') + (count ? (' ' + count) : '');
        } else {
          const parts = [];
          if (code) parts.push(code + ':');
          if (count) parts.push(count);
          if (type) parts.push(type);
          line = parts.join(' ');
        }
        if (line) out.push(line);
      });
    }
    while (out.length && out[out.length-1]==='') out.pop();
    return out.join('\n');
  }

  function formatNoteText(code,count,type){
    if (!code && !count && !type) return '';
    const parts = [];
    if (code) parts.push(code + ':');
    if (count) parts.push(count);
    if (type) parts.push(type);
    return parts.join(' ');
  }

  function createNoteItem(code,count,type){
    const wrapper = document.createElement('div');
    wrapper.className = 'note-item';
    wrapper.dataset.code = code||'';
    wrapper.dataset.count = count||'';
    wrapper.dataset.type = type||'';
    wrapper.dataset.mention = '';
    const txt = document.createElement('span'); txt.className='note-text';
    txt.textContent = formatNoteText(code,count,type);
    const playerWrap = document.createElement('div'); playerWrap.className='player-wrap';
    const chk = document.createElement('input'); chk.type='checkbox'; chk.className='playerChk';
    const lbl = document.createElement('span'); lbl.textContent='لاعب';
    const mention = document.createElement('input'); mention.className='playerMention'; mention.placeholder='@player'; mention.style.display='none';
    chk.addEventListener('change', ()=>{ mention.style.display = chk.checked ? 'inline-block' : 'none'; if (!chk.checked) mention.value=''; });
    mention.addEventListener('input', ()=> wrapper.dataset.mention = mention.value.trim());
    playerWrap.appendChild(chk); playerWrap.appendChild(lbl); playerWrap.appendChild(mention);
    const actions = document.createElement('div');
    const edit = document.createElement('button'); edit.type='button'; edit.textContent='تعديل'; edit.className='edit-btn';
    const del = document.createElement('button'); del.type='button'; del.textContent='حذف'; del.className='del-btn';
    del.addEventListener('click', ()=> wrapper.remove());
    edit.addEventListener('click', ()=> enterEditMode(wrapper));
    actions.appendChild(edit); actions.appendChild(del);
    wrapper.appendChild(txt); wrapper.appendChild(playerWrap); wrapper.appendChild(actions);
    return wrapper;
  }

  function enterEditMode(wrapper){
    alert('فتح وضع التعديل (مختصر في النسخة هذه).');
  }

  document.getElementById('addNoteBtn').addEventListener('click', ()=>{
    const code = document.getElementById('noteCode').value.trim();
    const count = document.getElementById('noteCount').value.trim();
    const type = document.getElementById('noteType').value;
    if (!code && !count && !type) return;
    const item = createNoteItem(code,count,type);
    document.getElementById('notesList').appendChild(item);
    document.getElementById('noteCode').value=''; document.getElementById('noteCount').value='';
  });

  const buildBtn = document.getElementById('buildReport');
  const copyBtn = document.getElementById('copyReport');
  const output = document.getElementById('reportOutput');
  buildBtn.addEventListener('click', ()=>{
    output.value = buildReportText();
    copyBtn.style.display='inline-block';
    output.focus(); output.select();
  });
  copyBtn.addEventListener('click', async ()=>{
    try { await navigator.clipboard.writeText(output.value); copyBtn.textContent='تم النسخ ✓'; setTimeout(()=>copyBtn.textContent='نسخ التقرير',1500); } catch(e){ alert('فشل النسخ'); }
  });
</script>
</body>
</html>
