<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تقرير العمليات - الميناء (نمذج التوسعات)</title>
<link href="./style.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --accent:#27ae60; --muted:#9b9b9b; --bg:#0b0b0b; --card:#1d1c1c; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Cairo', system-ui, Arial, sans-serif;
      background:transparent;
      color:#eee;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:18px;
      direction: rtl; /* الصفحة من اليمين لليسار */
    }

    .top-nav{padding:12px 18px;}
    .top-nav nav { display:flex; gap:8px; align-items:center; justify-content:flex-start; flex-wrap:wrap; }
    .btn-pill {
      display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:6px 14px;
      height:34px; line-height:1; font-size:14px; border-radius:18px; font-weight:700; white-space:nowrap;
    }
    .btn-pill.outline { background:transparent; color:var(--accent); border:1px solid var(--accent); }
    .btn-pill.filled { background:var(--accent); color:#fff; border:1px solid var(--accent); }

    .card{
      max-width:1100px;
      margin:0 auto;
      background:linear-gradient(#1a1a1a,#212121);
      border-radius:12px;
      padding:18px;
      box-shadow:0 8px 30px rgba(0,0,0,0.6);
    }

    .title{ text-align:center; color:var(--accent); margin:0 0 6px; font-size:26px; letter-spacing:1px; }
    .small-note{ color:var(--muted); font-size:13px; margin-bottom:8px; text-align:right; }

    .section { margin-bottom:18px; border-top:1px dashed rgba(255,255,255,0.03); padding-top:12px; }
    .section h3 {
      margin: 10px 0 6px;
      font-size:16px;
      color:var(--accent);
    }

    .row { display:flex; gap:8px; align-items:center; margin-bottom:10px; }
    .row label { min-width:160px; font-size:14px; color:#ddd; }
    .row .input { flex:1; margin-bottom:0; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.04); background:#222; color:#ddd }

    .add-btn { background:transparent; color:var(--accent); border:1px dashed rgba(39,174,96,0.35); padding:6px 10px; border-radius:8px; cursor:pointer; }
    .controls { display:flex; gap:8px; margin-top:10px; }
    .report-output { width:100%; min-height:220px; resize:vertical; padding:12px; background:#222; color:#ddd; border-radius:8px; border:1px solid rgba(255,255,255,0.03); white-space:pre-wrap; direction:rtl; }

    .del-btn { background:transparent; border:1px solid rgba(255,255,255,0.06); color:#ff6b6b; padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700; }
    .edit-btn { background:transparent; border:1px dashed rgba(255,255,255,0.06); color:#ffd36b; padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700; }
    .hide-btn { background:transparent; border:1px solid rgba(255,255,255,0.06); color:#9b9b9b; padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700; }

    .role.duplicate { border-color:#e74c3c !important; color:#ffb3b3 !important; background:rgba(231,76,60,0.04); }
    .row label.duplicate-label { color:#ff6b6b !important; }
    #dupWarning { color:#ff6b6b; display:none; margin-top:8px; font-size:13px; }

    .note-item{ display:flex; gap:8px; align-items:center; justify-content:space-between; padding:6px 8px; border-radius:6px; background:#141414; border:1px solid rgba(255,255,255,0.02); }
    .note-text{ color:#ddd; flex:1; padding-right:8px; }
    .note-actions{ display:flex; gap:6px; align-items:center; margin-left:8px; }

    /* player control appended at end so ترتيب الصف لا يتغير */
    .playerControl { display:flex; gap:6px; align-items:center; direction:rtl; }
    .playerControl .playerChk { width:18px; height:18px; cursor:pointer; }
    .playerControl .playerMention { width:140px; padding:6px; border-radius:6px; border:1px solid rgba(255,255,255,0.04); background:#222; color:#ddd; display:none; font-size:13px; direction:rtl; text-align:right }

    /* --- Note input group (المستطيل) --- */
    .note-inputs {
      display:flex;
      gap:8px;
      align-items:center;
      background:linear-gradient(#121212,#181818);
      border:1px solid rgba(255,255,255,0.04);
      padding:8px;
      border-radius:10px;
      width:100%;
    }
    .input.small { padding:6px 8px; font-size:13px; height:34px; box-sizing:border-box; }
    #noteCode.input.small { width:150px; }
    #noteType.input.small { width:110px; }
    #noteTypeNumber.input.small { width:70px; }
    #noteCount.input.small { width:70px; }
    #addNoteBtn { height:34px; }

    @media (max-width:980px){
      .card{width:92%; padding:16px;}
      .title{font-size:22px}
      .row label{min-width:120px}
      .playerControl .playerMention{width:100px;}
      #noteCode.input.small { width:120px; }
      #noteType.input.small { width:90px; }
      #noteTypeNumber.input.small { width:60px; }
      #noteCount.input.small { width:60px; }
    }
    @media (max-width:480px){
      .card{width:92%}
      .title{font-size:20px}
      .row label{min-width:100px}
      .playerControl .playerMention{width:80px;}
      .note-inputs { flex-wrap:wrap; gap:6px; }
      #noteCode.input.small { width:100%; flex:1 1 auto; }
      #noteType.input.small, #noteTypeNumber.input.small, #noteCount.input.small { width:80px; flex:0 0 auto; }
    }
  </style>
</head>
<body>
  <div class="bg-mark" aria-hidden="true"></div>

  <section class="card">
    <h1 style="margin:0 0 8px;color:var(--accent);"> تقرير العمليات في التوسعات</h1>
    <form id="reportForm" onsubmit="return false;">
      <div class="section">
        <div class="row"><label>وقت استلام الشفت</label><input id="shiftTimeDisplay" class="input" value="6 صباحا" readonly></div>
      </div>

      <div class="section">
        <h3 style="margin:0 0 8px;color:var(--accent)">العمليات الأساسية</h3>

        <div id="radaList">
          <div class="row"><label>ردع 1</label><input class="input role" value="H-000" data-role="ردع 1"></div>
          <div class="row"><label>ردع 2</label><input class="input role" value="H-000" data-role="ردع 2"></div>
        </div>

        <div id="barqList" style="margin-top:8px">
          <div class="row"><label>برق 1</label><input class="input role" value="H-000" data-role="برق 1"></div>
          <div class="row"><label>برق 2</label><input class="input role" value="H-000" data-role="برق 2"></div>
        </div>

        <div id="saqrList" style="margin-top:8px">
          <div class="row"><label>صقر 1</label><input class="input role" value="H-000" data-role="صقر 1"></div>
          <div class="row"><label>صقر 2</label><input class="input role" value="H-000" data-role="صقر 2"></div>
          <div class="row"><label>صقر 3</label><input class="input role" value="H-000" data-role="صقر 3"></div>
          <div class="row"><label>صقر 4</label><input class="input role" value="H-000" data-role="صقر 4"></div>
        </div>

        <div id="sahmList" style="margin-top:8px">
          <div class="row"><label>سهم 1</label><input class="input role" value="H-000" data-role="سهم 1"></div>
          <div class="row"><label>سهم 2</label><input class="input role" value="H-000" data-role="سهم 2"></div>
          <div class="row"><label>سهم 3</label><input class="input role" value="H-000" data-role="سهم 3"></div>
        </div>
      </div>

      <div class="section" id="expansions">
        <h3 style="margin:0 0 8px;color:var(--accent)">التوسعات</h3>

        <div class="row" style="margin:6px 0"><strong>توسعه ( 1 )</strong></div>
        <div id="exp1SecurityList">
          <div class="row"><label>أمن 1</label><input class="input role" value="H-000" data-role="أمن 1"></div>
          <div class="row"><label>أمن 2</label><input class="input role" value="H-000" data-role="أمن 2"></div>
        </div>
        <div id="exp1HuraList" style="margin-top:6px">
          <div class="row"><label>حرة 1</label><input class="input role" value="H-000" data-role="حرة 1"></div>
          <div class="row"><label>حرة 2</label><input class="input role" value="H-000" data-role="حرة 2"></div>
        </div>

        <div class="row" style="margin:10px 0 6px"><strong>توسعه ( 2 )</strong></div>
        <div id="exp2SecurityList">
          <div class="row"><label>أمن 1</label><input class="input role" value="H-000" data-role="أمن 1"></div>
          <div class="row"><label>أمن 2</label><input class="input role" value="H-000" data-role="أمن 2"></div>
        </div>
        <div id="exp2HuraList" style="margin-top:6px">
          <div class="row"><label>حرة 1</label><input class="input role" value="H-000" data-role="حرة 1"></div>
          <div class="row"><label>حرة 2</label><input class="input role" value="H-000" data-role="حرة 2"></div>
        </div>

        <div class="row" style="margin:10px 0 6px"><strong>توسعه ( 3 )</strong></div>
        <div id="exp3SecurityList">
          <div class="row"><label>أمن 1</label><input class="input role" value="H-000" data-role="أمن 1"></div>
          <div class="row"><label>أمن 2</label><input class="input role" value="H-000" data-role="أمن 2"></div>
        </div>
        <div id="exp3HuraList" style="margin-top:6px">
          <div class="row"><label>حرة 1</label><input class="input role" value="H-000" data-role="حرة 1"></div>
          <div class="row"><label>حرة 2</label><input class="input role" value="H-000" data-role="حرة 2"></div>
        </div>

        <div class="row" style="margin:10px 0 6px"><strong>توسعه ( 4 )</strong></div>
        <div id="exp4SecurityList">
          <div class="row"><label>أمن 1</label><input class="input role" value="H-000" data-role="أمن 1"></div>
          <div class="row"><label>أمن 2</label><input class="input role" value="H-000" data-role="أمن 2"></div>
        </div>
        <div id="exp4HuraList" style="margin-top:6px">
          <div class="row"><label>حرة 1</label><input class="input role" value="H-000" data-role="حرة 1"></div>
          <div class="row"><label>حرة 2</label><input class="input role" value="H-000" data-role="حرة 2"></div>
        </div>
      </div>

      <div class="section" id="notesSection">
        <div class="row"><label>ملاحظة رئيسية</label><input id="noteField" class="input" value=""></div>

        <div class="row" style="align-items:flex-start">
          <label>إضافة بند</label>
          <div style="flex:1;display:flex;flex-direction:column;gap:8px">
            <!-- المجموعه داخل المستطيل -->
            <div class="note-inputs" aria-label="حقل إضافة ملاحظة">
              <input id="noteCode" class="input small" placeholder="مثال: H-018">
              <select id="noteType" class="input small">
                <option value="">نوع</option>
                <option value="حرة">حرة</option>
                <option value="سهم">سهم</option>
                <option value="صقر">صقر</option>
                <option value="برق">برق</option>
                <option value="ردع">ردع</option>
              </select>
              <input id="noteTypeNumber" class="input small" placeholder="رقم التوسعه (مثال: 7)">
              <input id="noteCount" class="input small" placeholder="ت 1">
              <button type="button" id="addNoteBtn" class="add-btn">＋ إضافة</button>
              
        </div>

        <div class="row" style="align-items:flex-start">
          <label>ملاحظات مضافة</label>
          <div id="notesList" style="flex:1;display:flex;flex-direction:column;gap:6px"></div>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center" class="section">
        <button id="buildReport" type="button" class="btn primary">انشاء التقرير</button>
        <button id="copyReport" type="button" class="btn secondary" style="display:none">نسخ التقرير</button>
      </div>

      <div style="margin-top:12px">
        <textarea id="reportOutput" class="report-output" placeholder="سيظهر التقرير هنا بعد الضغط"></textarea>
      </div>
    </form>
  </section>

<script>
document.addEventListener('DOMContentLoaded', () => {
  try {
    // Helpers
    function extractSuffixNumber(labelText){
      if (!labelText) return '';
      const m = labelText.trim().match(/(\d+)\s*$/);
      return m ? m[1] : '';
    }

    // formatLine: لا تضيف "توجيه و منشن"
    function formatLine(roleName, value){
      const n = extractSuffixNumber(roleName);
      return roleName + ' : ' + value + (n ? ' | ت ' + n : '');
    }

    // قراءة قيمة الصف: إذا مفعل خيار اللاعب فخذ قيمة حقل المنشن (نص حر) وإلا خذ قيمة حقل .role
    function readRowValue(row){
      if (!row) return null;
      const roleName = (row.querySelector('label')||{}).textContent || '';
      const codeInput = row.querySelector('.role');
      const playerChk = row.querySelector('.playerChk');
      const mention = row.querySelector('.playerMention');
      let val = 'H-000';
      if (playerChk && playerChk.checked){
        const raw = (mention && mention.value) ? mention.value.trim() : '';
        val = raw ? raw : '@';
      } else if (codeInput){
        val = (codeInput.value && codeInput.value.trim()) ? codeInput.value.trim() : 'H-000';
      }
      return { roleName, val };
    }

    function buildReportText(){
      const out = [];
      const shiftLabel = 'الميناء';
      const timeLabel = (document.getElementById('shiftTimeDisplay') && document.getElementById('shiftTimeDisplay').value) || '6 صباحا';

      out.push('تقرير العمليات في التوسعات ');
      out.push('');
      out.push('تم استلام عمليات ' + shiftLabel + ' في تمام الساعه ' + timeLabel + ' ');
      out.push('');

      ['radaList','barqList','saqrList','sahmList'].forEach(id=>{
        const container = document.getElementById(id);
        if (!container) return;
        const rows = container.querySelectorAll('.row');
        rows.forEach(r=>{
          if (r.dataset.hidden==='true' || getComputedStyle(r).display==='none') return;
          const data = readRowValue(r);
          if (data && data.roleName) out.push(formatLine(data.roleName, data.val));
        });
        out.push('');
      });

      function appendExpansion(n){
        out.push('توسعه ( ' + n + ' ) ');
        const sec = document.getElementById('exp'+n+'SecurityList');
        if (sec){
          const rows = sec.querySelectorAll('.row');
          rows.forEach(r=>{
            if (r.dataset.hidden==='true' || getComputedStyle(r).display==='none') return;
            const d = readRowValue(r);
            if (d && d.roleName) out.push(formatLine(d.roleName, d.val));
          });
        }
        out.push('');
        const hura = document.getElementById('exp'+n+'HuraList');
        if (hura){
          const rows = hura.querySelectorAll('.row');
          rows.forEach(r=>{
            if (r.dataset.hidden==='true' || getComputedStyle(r).display==='none') return;
            const d = readRowValue(r);
            if (d && d.roleName) out.push(formatLine(d.roleName, d.val));
          });
        }
        out.push('');
      }

      [1,2,3,4].forEach(appendExpansion);

      const noteItems = Array.from(document.querySelectorAll('#notesList .note-item'));
      out.push('`ملاحظات التقرير :`');
      out.push('');
      const mainNote = (document.getElementById('noteField')||{value:''}).value.trim();
      if (mainNote) out.push(mainNote);

      if (noteItems.length){
        noteItems.forEach(it=>{
          const code = it.dataset.code||'';
          const count = it.dataset.count||'';
          const type = it.dataset.type||'';
          const typeNum = it.dataset.typeNum||'';
          const line = formatNoteText(type, typeNum, code, count);
          if (line) out.push(line);
        });
      }

      while (out.length && out[out.length-1]==='') out.pop();
      return out.join('\n');
    }

    // --- Add player mention controls to each role row (appended, بدون قائمة أسماء) ---
    function attachPlayerControlToRow(row){
      if (!row || row.querySelector('.playerControl')) return;
      if (!row.querySelector('.role')) return;

      const control = document.createElement('div');
      control.className = 'playerControl';
      control.dir = 'rtl';

      const chk = document.createElement('input');
      chk.type = 'checkbox';
      chk.className = 'playerChk';
      chk.title = 'لاعب معتمد (اضغط لإظهار حقل الاسم)';

      const lbl = document.createElement('span');
      lbl.textContent = 'لاعب معتمد';
      lbl.style.fontSize = '13px';
      lbl.style.color = '#ddd';

      const mention = document.createElement('input');
      mention.type = 'text';
      mention.className = 'playerMention';
      mention.placeholder = '@اسم الاعب ';
      mention.setAttribute('dir', 'rtl');
      mention.style.display = 'none';

      // No datalist / no suggestions — user types الاسم يدوياً
      chk.addEventListener('change', () => {
        mention.style.display = chk.checked ? 'inline-block' : 'none';
        if (!chk.checked) mention.value = '';
      });

      control.appendChild(chk);
      control.appendChild(lbl);
      control.appendChild(mention);

      // Append so original label+input order stays the same
      row.appendChild(control);
    }

    // Attach to existing rows
    document.querySelectorAll('.row').forEach(r => attachPlayerControlToRow(r));

    // Observe for future added rows
    const observer = new MutationObserver(muts => {
      muts.forEach(m => {
        m.addedNodes.forEach(n => {
          if (n.nodeType === 1 && n.matches('.row')) attachPlayerControlToRow(n);
          if (n.querySelectorAll) {
            n.querySelectorAll('.row').forEach(r => attachPlayerControlToRow(r));
          }
        });
      });
    });
    observer.observe(document.body, { childList: true, subtree: true });

    // Notes helpers (with select for type and separate type number)
    function normalizeType(value){
      return value ? value.trim() : '';
    }

    function normalizeTypeNumber(value){
      if (!value) return '';
      return (value+'').trim();
    }

    function formatNoteText(type, typeNum, code, count){
      const t = normalizeType(type);
      const tn = normalizeTypeNumber(typeNum);
      const c = code ? code.trim() : '';
      const cnt = count ? count.trim() : '';

      const typePart = t ? (t + (tn ? tn : '')) : '';
      if (typePart && c) {
        return typePart + ': ' + c + (cnt ? ' | ' + cnt : '');
      }
      if (!typePart && c) {
        return c + (cnt ? ' | ' + cnt : '');
      }
      if (typePart && !c) {
        return typePart + (cnt ? ' | ' + cnt : '');
      }
      if (cnt) return cnt;
      return '';
    }

    function createNoteItem(code,count,type,typeNum){
      const wrapper = document.createElement('div');
      wrapper.className = 'note-item';
      wrapper.dataset.code = code||'';
      wrapper.dataset.count = count||'';
      wrapper.dataset.type = type||'';
      wrapper.dataset.typeNum = typeNum||'';

      const txt = document.createElement('span'); txt.className='note-text';
      txt.textContent = formatNoteText(wrapper.dataset.type, wrapper.dataset.typeNum, wrapper.dataset.code, wrapper.dataset.count);

      const actions = document.createElement('div');
      const edit = document.createElement('button'); edit.type='button'; edit.textContent='تعديل'; edit.className='edit-btn';
      const del = document.createElement('button'); del.type='button'; del.textContent='حذف'; del.className='del-btn';
      del.addEventListener('click', ()=> wrapper.remove());
      edit.addEventListener('click', ()=> enterEditMode(wrapper));
      actions.appendChild(edit); actions.appendChild(del);

      wrapper.appendChild(txt); wrapper.appendChild(actions);
      return wrapper;
    }

    function enterEditMode(wrapper){
      const currentCode = wrapper.dataset.code||'';
      const currentCount = wrapper.dataset.count||'';
      const currentType = wrapper.dataset.type||'';
      const currentTypeNum = wrapper.dataset.typeNum||'';
      const txt = wrapper.querySelector('.note-text');
      if (!txt) return;
      const editor = document.createElement('div'); editor.style.display='flex'; editor.style.gap='8px'; editor.style.alignItems='center';
      const codeIn = document.createElement('input'); codeIn.className='input small'; codeIn.value=currentCode;
      const countIn = document.createElement('input'); countIn.className='input small'; countIn.value=currentCount;

      // select for type
      const typeSel = document.createElement('select'); typeSel.className='input small';
      ['', 'حرة','سهم','صقر','برق','ردع'].forEach(v=>{
        const o = document.createElement('option');
        o.value = v;
        o.textContent = v || 'نوع';
        if (v === currentType) o.selected = true;
        typeSel.appendChild(o);
      });
      const typeNumIn = document.createElement('input'); typeNumIn.className='input small'; typeNumIn.placeholder='رقم التوسعه (مثال: 7)'; typeNumIn.value = currentTypeNum;

      const save = document.createElement('button'); save.type='button'; save.className='add-btn'; save.textContent='حفظ';
      const cancel = document.createElement('button'); cancel.type='button'; cancel.className='del-btn'; cancel.textContent='إلغاء';

      save.addEventListener('click', ()=>{
        wrapper.dataset.code = codeIn.value.trim();
        wrapper.dataset.count = countIn.value.trim();
        wrapper.dataset.type = typeSel.value;
        wrapper.dataset.typeNum = typeNumIn.value.trim();
        txt.textContent = formatNoteText(wrapper.dataset.type, wrapper.dataset.typeNum, wrapper.dataset.code, wrapper.dataset.count);
        editor.replaceWith(txt);
      });

      cancel.addEventListener('click', ()=> editor.replaceWith(txt));

      editor.appendChild(codeIn); editor.appendChild(typeSel); editor.appendChild(typeNumIn); editor.appendChild(countIn);
      editor.appendChild(save); editor.appendChild(cancel);
      txt.replaceWith(editor);
    }

    // Hook up add note button
    const addNoteBtn = document.getElementById('addNoteBtn');
    if (addNoteBtn) {
      addNoteBtn.addEventListener('click', ()=>{
        const code = (document.getElementById('noteCode')||{value:''}).value.trim();
        const count = (document.getElementById('noteCount')||{value:''}).value.trim();
        const type = (document.getElementById('noteType')||{value:''}).value;
        const typeNum = (document.getElementById('noteTypeNumber')||{value:''}).value.trim();
        if (!code && !count && !type && !typeNum) return;
        const item = createNoteItem(code,count,type,typeNum);
        document.getElementById('notesList').appendChild(item);
        document.getElementById('noteCode').value=''; document.getElementById('noteCount').value=''; document.getElementById('noteType').value=''; document.getElementById('noteTypeNumber').value='';
      });
    } else console.warn('addNoteBtn not found');

    // Build & copy report
    const buildBtn = document.getElementById('buildReport');
    const copyBtn = document.getElementById('copyReport');
    const output = document.getElementById('reportOutput');
    if (buildBtn && output){
      buildBtn.addEventListener('click', ()=>{
        try {
          output.value = buildReportText();
          if (copyBtn) copyBtn.style.display='inline-block';
          output.focus(); output.select();
        } catch (err) {
          console.error('Error while building report:', err);
          alert('حدث خطأ أثناء إنشاء التقرير. تفقد Console للمزيد من التفاصيل.');
        }
      });
    } else {
      console.warn('buildReport or reportOutput element missing');
    }

    if (copyBtn){
      copyBtn.addEventListener('click', async ()=>{
        try {
          await navigator.clipboard.writeText(output.value);
          const prev = copyBtn.textContent;
          copyBtn.textContent='تم النسخ ✓';
          setTimeout(()=> copyBtn.textContent = prev, 1500);
        } catch(e){
          console.error('Clipboard write failed', e);
          alert('فشل النسخ إلى الحافظة. تحقق من أذونات الموقع.');
        }
      });
    }

    console.log('Report script initialized successfully.');
  } catch (e) {
    console.error('Fatal error initializing report script:', e);
  }
});
</script>
</body>
</html>
